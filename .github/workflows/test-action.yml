# Copyright Kani Contributors
# SPDX-License-Identifier: Apache-2.0 OR MIT
name: Kani Action Check
on: pull_request

jobs:
  test-action:
    runs-on: ubuntu-latest
    name: Ensure that the Kani action continues to work
    steps:
      # To use this repository's private action,
      # you must check out the repository
      - name: Checkout
        uses: actions/checkout@v3

      - name: Run Kani with invalid version
        uses: ./ # Uses the action in the root directory
        with:
          working-directory: tests/cargo-kani/simple-lib
          kani-version: '0.47.0'
        continue-on-error: true  # Continue to the next steps even if this job fails

      - name: Check for Expected Error with invalid version
        run: |
          # Check if the error output contains the expected error substring
          if echo "${{ steps.run-and-check.outputs.invalid_value }}" | grep -q "could not find `kani-verifier` in registry `crates-io` with version `=0.47.0`"; then
            echo "Error message contains the expected substring."
          else
            echo "Error message does not contain the expected substring."
            exit 1  # Fail the job
          fi

      - name: Run Kani with older version
        uses: ./ # Uses the action in the root directory
        with:
          working-directory: tests/cargo-kani/simple-lib
          kani-version: 0.33.0
      - name: Run Kani
        uses: ./ # Uses the action in the root directory
        with:
          working-directory: tests/cargo-kani/simple-lib
      - name: Test ProfProof within Kani Action
        uses: ./
        with:
          working-directory: tests/cargo-kani/proptest-lib
          args: --tests
          enable-propproof: true
